# No trigger, this can be manually ran to build fresh queues
trigger: none

pool:
  vmImage: 'ubuntu-18.04'

# This formats the Build.BuildNumber
name: $(Year:yyyy).$(Month).$(DayOfMonth).$(Rev:r)

variables:
  - template: ./_pipeline/vars.yml

stages:
  - stage:
    displayName: 'Tracking'
    jobs:
      - job: Metadata
        displayName: 'Capture pipeline and build metadata'
        timeoutInMinutes: 1
        steps:
          - template: _pipeline/templates/meta.yml

  - stage: Build
    displayName: 'Lint, Test, Build & Publish'
    jobs:
      - job: LintBuildTest
        displayName: 'Lint Build Test'
        timeoutInMinutes: 30
        variables:
          DeploymentEnvironment: 'dev'
          AwsRegion: us-east-1
          DesiredInstanceCount: 1
        workspace:
          clean: all
        steps:
          - template: _pipeline/templates/ci-tools.yml

          - template: _pipeline/templates/lint.yml

          - template: _pipeline/templates/test.yml

          - template: _pipeline/templates/publish-to-registry.yml
            parameters:
              AwsRegions: ['us-east-1']

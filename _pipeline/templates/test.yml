steps:
  - script: |
      cargo make docker-test
    displayName: 'Test in docker'

  - script: |
      sudo chown -R vsts:docker reports
      sudo chown -R vsts:docker coverage
    displayName: 'Correct directory ownership.'

  - script: |
      cargo make junit
    displayName: 'Convert test output to junit'

  - task: reportgenerator@4
    inputs:
      reports: 'coverage/lcov.info'
      targetdir: 'coverage/'
      reporttypes: 'Cobertura;HtmlSummary'
    displayName: 'Converting lcov to cobertura'

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'reports/test_results.xml'
    displayName: 'Publish test results'

  - script: |
      ls -la coverage
      ls -la $(Build.SourcesDirectory)
    displayName: 'Debug'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: cobertura
      summaryFileLocation: 'coverage/Cobertura.xml'
      reportDirectory: 'coverage'
#      failIfCoverageEmpty: true
    displayName: 'Publish code coverage'
